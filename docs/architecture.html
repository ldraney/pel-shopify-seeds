<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEL Shopify Automation Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        h1, h2, h3 { color: #333; }
        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
        }
        .question {
            background: #cce5ff;
            border-left: 4px solid #007bff;
            padding: 1rem;
            margin: 1rem 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }
        th { background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>PEL Shopify Automation Architecture</h1>

    <h2>Overview: The Three-Repo System</h2>

    <div class="diagram-container">
        <pre class="mermaid">
flowchart LR
    subgraph seeds["pel-shopify-seeds"]
        CSV[CSV Files]
        API[API Call Definitions]
        REL1[GitHub Release]
    end

    subgraph views["pel-shopify-views"]
        INGEST[Ingest Release Assets]
        SQLITE[(SQLite DB)]
        REL2[GitHub Release + DB]
    end

    subgraph update["pel-shopify-update"]
        CONSUME[Consume Seeded DB]
        SYNC[Sync to Shopify]
    end

    CSV --> REL1
    API --> REL1
    REL1 -->|"download artifacts"| INGEST
    INGEST --> SQLITE
    SQLITE --> REL2
    REL2 -->|"download seeded DB"| CONSUME
    CONSUME --> SYNC
    SYNC -->|"CSV Import + API Calls"| SHOPIFY[(Shopify Store)]
        </pre>
    </div>

    <h2>Repo 1: pel-shopify-seeds</h2>
    <p>This repo is the <strong>source of truth</strong> for your catalog data.</p>

    <div class="diagram-container">
        <pre class="mermaid">
flowchart TD
    subgraph sources["Data Sources"]
        MANUAL[Manual Edits]
        SCRIPTS[Generation Scripts]
    end

    subgraph outputs["Release Artifacts"]
        PRODUCTS[products.csv]
        VARIANTS[variants.csv]
        IMAGES[images.csv]
        META[metafields.json]
        COLLECTIONS[collections.json]
    end

    MANUAL --> PRODUCTS
    MANUAL --> VARIANTS
    SCRIPTS --> IMAGES
    SCRIPTS --> META
    SCRIPTS --> COLLECTIONS

    PRODUCTS --> RELEASE[GitHub Release v1.0.0]
    VARIANTS --> RELEASE
    IMAGES --> RELEASE
    META --> RELEASE
    COLLECTIONS --> RELEASE
        </pre>
    </div>

    <h3>What Goes Where: CSV vs API</h3>

    <div class="note">
        <strong>Good news!</strong> Shopify's CSV export includes metafields as columns. This means most data can go through CSV import, simplifying the architecture.
    </div>

    <table>
        <thead>
            <tr>
                <th>Data Type</th>
                <th>Method</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Products (title, description, vendor, type)</td>
                <td>CSV</td>
                <td>Bulk import supported</td>
            </tr>
            <tr>
                <td>Variants (price, SKU, inventory)</td>
                <td>CSV</td>
                <td>Bulk import supported</td>
            </tr>
            <tr>
                <td>Product Images</td>
                <td>CSV</td>
                <td>Image Src, Position, Alt Text columns</td>
            </tr>
            <tr>
                <td>Metafields</td>
                <td>CSV</td>
                <td>Included as columns like <code>product.metafields.namespace.key</code></td>
            </tr>
            <tr>
                <td>Product Tags</td>
                <td>CSV</td>
                <td>Comma-separated in Tags column</td>
            </tr>
            <tr>
                <td>Product Options</td>
                <td>CSV</td>
                <td>Option1/2/3 Name/Value columns</td>
            </tr>
            <tr>
                <td>SEO (Title, Description)</td>
                <td>CSV</td>
                <td>SEO Title, SEO Description columns</td>
            </tr>
            <tr>
                <td>Google Shopping attributes</td>
                <td>CSV</td>
                <td>Multiple Google Shopping columns</td>
            </tr>
            <tr>
                <td>Collections</td>
                <td>API</td>
                <td>Not in product CSV - separate entity</td>
            </tr>
            <tr>
                <td>Multi-location Inventory</td>
                <td>API</td>
                <td>CSV only has single Variant Inventory Qty</td>
            </tr>
        </tbody>
    </table>

    <h3>Actual CSV Columns (65 total)</h3>
    <details>
        <summary>Click to expand full column list</summary>
        <table>
            <thead><tr><th>#</th><th>Column</th><th>Category</th></tr></thead>
            <tbody>
                <tr><td>1</td><td>Handle</td><td>Product ID</td></tr>
                <tr><td>2</td><td>Title</td><td>Product</td></tr>
                <tr><td>3</td><td>Body (HTML)</td><td>Product</td></tr>
                <tr><td>4</td><td>Vendor</td><td>Product</td></tr>
                <tr><td>5</td><td>Product Category</td><td>Product</td></tr>
                <tr><td>6</td><td>Type</td><td>Product</td></tr>
                <tr><td>7</td><td>Tags</td><td>Product</td></tr>
                <tr><td>8</td><td>Published</td><td>Product</td></tr>
                <tr><td>9-17</td><td>Option1/2/3 Name, Value, Linked To</td><td>Options</td></tr>
                <tr><td>18</td><td>Variant SKU</td><td>Variant</td></tr>
                <tr><td>19</td><td>Variant Grams</td><td>Variant</td></tr>
                <tr><td>20</td><td>Variant Inventory Tracker</td><td>Variant</td></tr>
                <tr><td>21</td><td>Variant Inventory Qty</td><td>Variant</td></tr>
                <tr><td>22</td><td>Variant Inventory Policy</td><td>Variant</td></tr>
                <tr><td>23</td><td>Variant Fulfillment Service</td><td>Variant</td></tr>
                <tr><td>24</td><td>Variant Price</td><td>Variant</td></tr>
                <tr><td>25</td><td>Variant Compare At Price</td><td>Variant</td></tr>
                <tr><td>26</td><td>Variant Requires Shipping</td><td>Variant</td></tr>
                <tr><td>27</td><td>Variant Taxable</td><td>Variant</td></tr>
                <tr><td>28-31</td><td>Unit Price Measure fields</td><td>Variant</td></tr>
                <tr><td>32</td><td>Variant Barcode</td><td>Variant</td></tr>
                <tr><td>33</td><td>Image Src</td><td>Image</td></tr>
                <tr><td>34</td><td>Image Position</td><td>Image</td></tr>
                <tr><td>35</td><td>Image Alt Text</td><td>Image</td></tr>
                <tr><td>36</td><td>Gift Card</td><td>Product</td></tr>
                <tr><td>37</td><td>SEO Title</td><td>SEO</td></tr>
                <tr><td>38</td><td>SEO Description</td><td>SEO</td></tr>
                <tr><td>39-48</td><td>Google Shopping fields</td><td>Google</td></tr>
                <tr><td>49</td><td>product.metafields.custom.product_detail_description</td><td>Metafield</td></tr>
                <tr><td>50</td><td>product.metafields.custom.short_description</td><td>Metafield</td></tr>
                <tr><td>51</td><td>product.metafields.ingredients.inci_list</td><td>Metafield</td></tr>
                <tr><td>52</td><td>product.metafields.mm-google-shopping.custom_product</td><td>Metafield</td></tr>
                <tr><td>53</td><td>product.metafields.product_details.benefits</td><td>Metafield</td></tr>
                <tr><td>54</td><td>product.metafields.product_details.key_features</td><td>Metafield</td></tr>
                <tr><td>55</td><td>product.metafields.product_details.skin_type</td><td>Metafield</td></tr>
                <tr><td>56</td><td>product.metafields.product_details.usage_instructions</td><td>Metafield</td></tr>
                <tr><td>57</td><td>product.metafields.reviews.rating_count</td><td>Metafield</td></tr>
                <tr><td>58</td><td>product.metafields.shopify.constitutive-ingredients</td><td>Metafield</td></tr>
                <tr><td>59</td><td>product.metafields.shopify.package-type</td><td>Metafield</td></tr>
                <tr><td>60</td><td>Variant Image</td><td>Variant</td></tr>
                <tr><td>61</td><td>Variant Weight Unit</td><td>Variant</td></tr>
                <tr><td>62</td><td>Variant Tax Code</td><td>Variant</td></tr>
                <tr><td>63</td><td>Cost per item</td><td>Variant</td></tr>
                <tr><td>64</td><td>Status</td><td>Product</td></tr>
            </tbody>
        </table>
    </details>

    <h2>Repo 2: pel-shopify-views</h2>
    <p>This repo <strong>transforms</strong> the seed data into a queryable SQLite database.</p>

    <div class="diagram-container">
        <pre class="mermaid">
flowchart TD
    subgraph input["Input: Download from pel-shopify-seeds release"]
        DL[Download Release Assets]
    end

    subgraph process["Processing"]
        PARSE_CSV[Parse CSVs]
        PARSE_JSON[Parse JSON API definitions]
        SCHEMA[Create Schema]
        INSERT[Insert Data]
    end

    subgraph output["Output"]
        DB[(catalog.sqlite)]
        REL[GitHub Release]
    end

    DL --> PARSE_CSV
    DL --> PARSE_JSON
    PARSE_CSV --> SCHEMA
    PARSE_JSON --> SCHEMA
    SCHEMA --> INSERT
    INSERT --> DB
    DB --> REL
        </pre>
    </div>

    <h3>Proposed SQLite Schema (Based on Actual CSV)</h3>

    <div class="diagram-container">
        <pre class="mermaid">
erDiagram
    products {
        text handle PK
        text title
        text body_html
        text vendor
        text product_category
        text type
        text tags
        boolean published
        boolean gift_card
        text seo_title
        text seo_description
        text status
    }

    variants {
        text sku PK
        text product_handle FK
        text option1_name
        text option1_value
        text option2_name
        text option2_value
        text option3_name
        text option3_value
        int grams
        text inventory_tracker
        int inventory_qty
        text inventory_policy
        text fulfillment_service
        real price
        real compare_at_price
        boolean requires_shipping
        boolean taxable
        text barcode
        text image_url
        text weight_unit
        text tax_code
        real cost_per_item
    }

    images {
        int id PK
        text product_handle FK
        text src_url
        int position
        text alt_text
    }

    metafields {
        int id PK
        text product_handle FK
        text namespace
        text key
        text value
    }

    google_shopping {
        text product_handle PK
        text google_category
        text gender
        text age_group
        text mpn
        text condition
        text custom_product
        text label_0
        text label_1
        text label_2
        text label_3
        text label_4
    }

    products ||--o{ variants : "has"
    products ||--o{ images : "has"
    products ||--o{ metafields : "has"
    products ||--|| google_shopping : "has"
        </pre>
    </div>

    <div class="note">
        <strong>Metafields in your export:</strong>
        <ul>
            <li><code>custom.product_detail_description</code></li>
            <li><code>custom.short_description</code></li>
            <li><code>ingredients.inci_list</code></li>
            <li><code>mm-google-shopping.custom_product</code></li>
            <li><code>product_details.benefits</code></li>
            <li><code>product_details.key_features</code></li>
            <li><code>product_details.skin_type</code></li>
            <li><code>product_details.usage_instructions</code></li>
            <li><code>reviews.rating_count</code></li>
            <li><code>shopify.constitutive-ingredients</code></li>
            <li><code>shopify.package-type</code></li>
        </ul>
    </div>

    <h2>Repo 3: pel-shopify-update</h2>
    <p>This repo <strong>executes</strong> the updates against Shopify.</p>

    <div class="diagram-container">
        <pre class="mermaid">
flowchart TD
    subgraph input["Input"]
        DB[(catalog.sqlite from pel-shopify-views)]
    end

    subgraph process["Update Process"]
        DIFF[Compare with current Shopify state]
        GEN_CSV[Generate CSV for bulk import]
        GEN_API[Generate API mutation queue]
    end

    subgraph execute["Execution"]
        CSV_UP[CSV Upload via Admin]
        API_CALL[Execute GraphQL mutations]
    end

    subgraph shopify["Shopify"]
        STORE[(Shopify Store)]
    end

    DB --> DIFF
    DIFF --> GEN_CSV
    DIFF --> GEN_API
    GEN_CSV --> CSV_UP
    GEN_API --> API_CALL
    CSV_UP --> STORE
    API_CALL --> STORE
        </pre>
    </div>

    <h2>Complete Data Flow</h2>

    <div class="diagram-container">
        <pre class="mermaid">
sequenceDiagram
    participant Dev as Developer
    participant Seeds as pel-shopify-seeds
    participant Views as pel-shopify-views
    participant Update as pel-shopify-update
    participant Shopify as Shopify Store

    Dev->>Seeds: Edit CSVs / API definitions
    Dev->>Seeds: Push & Tag Release
    Seeds-->>Views: GitHub Action triggers
    Views->>Seeds: Download release assets
    Views->>Views: Build SQLite DB
    Views->>Views: Create release with DB
    Views-->>Update: (Manual or automated trigger)
    Update->>Views: Download seeded DB
    Update->>Shopify: Fetch current state
    Update->>Update: Calculate diff
    Update->>Shopify: Upload CSV (products/variants)
    Update->>Shopify: Execute API calls (metafields/collections)
    Shopify-->>Dev: Catalog updated!
        </pre>
    </div>

    <h2>Open Questions to Resolve</h2>

    <div class="question">
        <h3>1. What triggers the update?</h3>
        <ul>
            <li>Manual trigger from pel-shopify-update?</li>
            <li>Automated on every pel-shopify-views release?</li>
            <li>Scheduled (cron)?</li>
        </ul>
    </div>

    <div class="question">
        <h3>2. How do you handle Shopify IDs?</h3>
        <p>Products in Shopify have GIDs like <code>gid://shopify/Product/12345</code>. Your CSVs use handles. Options:</p>
        <ul>
            <li>Use handles as the canonical identifier (Shopify matches on handle for CSV import)</li>
            <li>Maintain a mapping table in pel-shopify-views</li>
            <li>Query Shopify for ID resolution before API calls</li>
        </ul>
    </div>

    <div class="question">
        <h3>3. State management</h3>
        <p>Should pel-shopify-update also store what it last pushed? This enables:</p>
        <ul>
            <li>Diffing against previous seeds (not just current Shopify state)</li>
            <li>Rollback capability</li>
            <li>Audit trail</li>
        </ul>
    </div>

    <div class="question">
        <h3>4. Environment handling</h3>
        <p>Do you have staging/production stores? If so, how does this pipeline handle them?</p>
    </div>

    <h2>Next Steps</h2>
    <ol>
        <li>Finalize which data types need API vs CSV</li>
        <li>Design the exact CSV format (Shopify has a specific schema)</li>
        <li>Define the JSON schema for API call definitions</li>
        <li>Set up GitHub Actions for the pipeline</li>
        <li>Implement each repo incrementally</li>
    </ol>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });
    </script>
</body>
</html>
